{"version":3,"sources":["meteor://ðŸ’»app/packages/lai:collection-extensions/collection-extensions.js"],"names":["Meteor","module","link","v","Mongo","CollectionExtensions","_extensions","addExtension","customFunction","Error","push","users","apply","addCollectionExtension","console","warn","arguments","addPrototype","name","Collection","prototype","addCollectionPrototype","reassignCollectionPrototype","instance","constr","hasSetPrototypeOf","Object","setPrototypeOf","__proto__","wrapCollection","ns","as","_CollectionPrototype","constructor","proto","ret","processCollectionExtensions","prop","hasOwnProperty","call","self","args","applyArgs","slice","undefined","extensions","i","len","length"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAIA,MAAJ;AAAWC,MAAM,CAACC,IAAP,CAAY,eAAZ,EAA4B;AAACF,QAAM,EAAC,UAASG,CAAT,EAAW;AAACH,UAAM,GAACG,CAAP;AAAS;AAA7B,CAA5B,EAA2D,CAA3D;AAA8D,IAAIC,KAAJ;AAAUH,MAAM,CAACC,IAAP,CAAY,cAAZ,EAA2B;AAACE,OAAK,EAAC,UAASD,CAAT,EAAW;AAACC,SAAK,GAACD,CAAN;AAAQ;AAA3B,CAA3B,EAAwD,CAAxD;AAInF;AACAE,oBAAoB,GAAG,EAAvB,C,CAA0B;AAE1B;;AACAA,oBAAoB,CAACC,WAArB,GAAmC,EAAnC,C,CAEA;AACA;;AACAD,oBAAoB,CAACE,YAArB,GAAoC,UAAUC,cAAV,EAA0B;AAC5D,MAAI,OAAOA,cAAP,KAA0B,UAA9B,EAA0C;AACxC,UAAM,IAAIR,MAAM,CAACS,KAAX,CACJ,qCADI,EAEJ,oEAFI,CAAN;AAGD;;AACDJ,sBAAoB,CAACC,WAArB,CAAiCI,IAAjC,CAAsCF,cAAtC,EAN4D,CAO5D;;;AACA,MAAI,OAAOR,MAAM,CAACW,KAAd,KAAwB,WAA5B,EAAyC;AACvCH,kBAAc,CAACI,KAAf,CAAqBZ,MAAM,CAACW,KAA5B,EAAmC,CAAC,OAAD,CAAnC;AACD;AACF,CAXD,C,CAaA;;;AACAX,MAAM,CAACa,sBAAP,GAAgC,YAAY;AAC1CC,SAAO,CAACC,IAAR,CAAa,+FAAb;AACAV,sBAAoB,CAACE,YAArB,CAAkCK,KAAlC,CAAwC,IAAxC,EAA8CI,SAA9C;AACD,CAHD,C,CAKA;AACA;;;AACAX,oBAAoB,CAACY,YAArB,GAAoC,UAAUC,IAAV,EAAgBV,cAAhB,EAAgC;AAClE,MAAI,OAAOU,IAAP,KAAgB,QAApB,EAA8B;AAC5B,UAAM,IAAIlB,MAAM,CAACS,KAAX,CACJ,qCADI,EAEJ,wFAFI,CAAN;AAGD;;AACD,MAAI,OAAOD,cAAP,KAA0B,UAA9B,EAA0C;AACxC,UAAM,IAAIR,MAAM,CAACS,KAAX,CACJ,qCADI,EAEJ,2FAFI,CAAN;AAGD;;AACD,GAAC,OAAOL,KAAP,KAAiB,WAAjB,GACGA,KAAK,CAACe,UADT,GAEGnB,MAAM,CAACmB,UAFX,EAEuBC,SAFvB,CAEiCF,IAFjC,IAEyCV,cAFzC;AAGD,CAdD,C,CAgBA;;;AACAR,MAAM,CAACqB,sBAAP,GAAgC,YAAY;AAC1CP,SAAO,CAACC,IAAR,CAAa,+FAAb;AACAV,sBAAoB,CAACY,YAArB,CAAkCL,KAAlC,CAAwC,IAAxC,EAA8CI,SAA9C;AACD,CAHD,C,CAKA;AACA;AACA;;;AACA,SAASM,2BAAT,CAAsCC,QAAtC,EAAgDC,MAAhD,EAAwD;AACtD,MAAMC,iBAAiB,GAAG,OAAOC,MAAM,CAACC,cAAd,KAAiC,UAA3D;AAEA,MAAI,CAACH,MAAL,EAAaA,MAAM,GAAG,OAAOpB,KAAP,KAAiB,WAAjB,GAA+BA,KAAK,CAACe,UAArC,GAAkDnB,MAAM,CAACmB,UAAlE,CAHyC,CAKtD;AACA;;AACA,MAAIM,iBAAJ,EAAuB;AACrBC,UAAM,CAACC,cAAP,CAAsBJ,QAAtB,EAAgCC,MAAM,CAACJ,SAAvC;AACD,GAFD,MAEO,IAAIG,QAAQ,CAACK,SAAb,EAAwB;AAAE;AACjC;AACEL,YAAQ,CAACK,SAAT,GAAqBJ,MAAM,CAACJ,SAA5B;AACD;AACF,C,CAED;AACA;AACA;;;AACA,SAASS,cAAT,CAAyBC,EAAzB,EAA6BC,EAA7B,EAAiC;AAC/B;AACA,MAAI,CAACA,EAAE,CAACC,oBAAR,EAA8BD,EAAE,CAACC,oBAAH,GAA0B,IAAID,EAAE,CAACZ,UAAP,CAAkB,IAAlB,CAA1B;AAE9B,MAAMc,WAAW,GAAGF,EAAE,CAACZ,UAAvB;AACA,MAAMe,KAAK,GAAGH,EAAE,CAACC,oBAAjB;;AAEAF,IAAE,CAACX,UAAH,GAAgB,YAAY;AAC1B,QAAMgB,GAAG,GAAGF,WAAW,CAACrB,KAAZ,CAAkB,IAAlB,EAAwBI,SAAxB,CAAZ,CAD0B,CAE1B;;AACAoB,+BAA2B,CAAC,IAAD,EAAOpB,SAAP,CAA3B;AACA,WAAOmB,GAAP;AACD,GALD;;AAOAL,IAAE,CAACX,UAAH,CAAcC,SAAd,GAA0Bc,KAA1B;AACAJ,IAAE,CAACX,UAAH,CAAcC,SAAd,CAAwBa,WAAxB,GAAsCH,EAAE,CAACX,UAAzC;;AAEA,OAAK,IAAMkB,IAAX,2CAAmBJ,WAAnB,GAAgC;AAC9B,QAAIP,MAAM,CAACN,SAAP,CAAiBkB,cAAjB,CAAgCC,IAAhC,CAAqCN,WAArC,EAAkDI,IAAlD,CAAJ,EAA6D;AAC3DP,QAAE,CAACX,UAAH,CAAckB,IAAd,IAAsBJ,WAAW,CAACI,IAAD,CAAjC;AACD;AACF;AACF;;AAED,SAASD,2BAAT,CAAsCI,IAAtC,EAA4CC,IAA5C,EAAkD;AAChD;AACA;AACA,MAAMC,SAAS,GAAGD,IAAI,GAAG,GAAGE,KAAH,CAASJ,IAAT,CAAcE,IAAd,EAAoB,CAApB,CAAH,GAA4BG,SAAlD;AACA,MAAMC,UAAU,GAAGxC,oBAAoB,CAACC,WAAxC;;AACA,OAAK,IAAIwC,CAAC,GAAG,CAAR,EAAWC,GAAG,GAAGF,UAAU,CAACG,MAAjC,EAAyCF,CAAC,GAAGC,GAA7C,EAAkDD,CAAC,EAAnD,EAAuD;AACrDD,cAAU,CAACC,CAAD,CAAV,CAAclC,KAAd,CAAoB4B,IAApB,EAA0BE,SAA1B;AACD;AACF;;AAED,IAAI,OAAOtC,KAAP,KAAiB,WAArB,EAAkC;AAChCyB,gBAAc,CAAC7B,MAAD,EAASI,KAAT,CAAd;AACAyB,gBAAc,CAACzB,KAAD,EAAQA,KAAR,CAAd;AACD,CAHD,MAGO;AACLyB,gBAAc,CAAC7B,MAAD,EAASA,MAAT,CAAd;AACD;;AAED,IAAI,OAAOA,MAAM,CAACW,KAAd,KAAwB,WAA5B,EAAyC;AACvC;AACAW,6BAA2B,CAACtB,MAAM,CAACW,KAAR,CAA3B;AACD,C","file":"/packages/lai_collection-extensions.js","sourcesContent":["/* global CollectionExtensions */\nimport { Meteor } from 'meteor/meteor'\nimport { Mongo } from 'meteor/mongo'\n\n// The collection extensions namespace\nCollectionExtensions = {} // eslint-disable-line no-global-assign\n\n// Stores all the collection extensions\nCollectionExtensions._extensions = []\n\n// This is where you would add custom functionality to\n// Mongo.Collection/Meteor.Collection\nCollectionExtensions.addExtension = function (customFunction) {\n  if (typeof customFunction !== 'function') {\n    throw new Meteor.Error(\n      'collection-extension-wrong-argument',\n      'You must pass a function into CollectionExtensions.addExtension().')\n  }\n  CollectionExtensions._extensions.push(customFunction)\n  // If Meteor.users exists, apply the extension right away\n  if (typeof Meteor.users !== 'undefined') {\n    customFunction.apply(Meteor.users, ['users'])\n  }\n}\n\n// Backwards compatibility\nMeteor.addCollectionExtension = function () {\n  console.warn('`Meteor.addCollectionExtension` is deprecated, please use `CollectionExtensions.addExtension`')\n  CollectionExtensions.addExtension.apply(null, arguments)\n}\n\n// Utility function to add a prototype function to your\n// Meteor/Mongo.Collection object\nCollectionExtensions.addPrototype = function (name, customFunction) {\n  if (typeof name !== 'string') {\n    throw new Meteor.Error(\n      'collection-extension-wrong-argument',\n      'You must pass a string as the first argument into CollectionExtensions.addPrototype().')\n  }\n  if (typeof customFunction !== 'function') {\n    throw new Meteor.Error(\n      'collection-extension-wrong-argument',\n      'You must pass a function as the second argument into CollectionExtensions.addPrototype().')\n  }\n  (typeof Mongo !== 'undefined'\n    ? Mongo.Collection\n    : Meteor.Collection).prototype[name] = customFunction\n}\n\n// Backwards compatibility\nMeteor.addCollectionPrototype = function () {\n  console.warn('`Meteor.addCollectionPrototype` is deprecated, please use `CollectionExtensions.addPrototype`')\n  CollectionExtensions.addPrototype.apply(null, arguments)\n}\n\n// This is used to reassign the prototype of unfortunately\n// and unstoppably already instantiated Mongo instances\n// i.e. Meteor.users\nfunction reassignCollectionPrototype (instance, constr) {\n  const hasSetPrototypeOf = typeof Object.setPrototypeOf === 'function'\n\n  if (!constr) constr = typeof Mongo !== 'undefined' ? Mongo.Collection : Meteor.Collection\n\n  // __proto__ is not available in < IE11\n  // Note: Assigning a prototype dynamically has performance implications\n  if (hasSetPrototypeOf) {\n    Object.setPrototypeOf(instance, constr.prototype)\n  } else if (instance.__proto__) { // eslint-disable-line no-proto\n  // eslint-disable-next-line no-proto\n    instance.__proto__ = constr.prototype\n  }\n}\n\n// This monkey-patches the Collection constructor\n// This code is the same monkey-patching code\n// that matb33:collection-hooks uses, which works pretty nicely\nfunction wrapCollection (ns, as) {\n  // Save the original prototype\n  if (!as._CollectionPrototype) as._CollectionPrototype = new as.Collection(null)\n\n  const constructor = as.Collection\n  const proto = as._CollectionPrototype\n\n  ns.Collection = function () {\n    const ret = constructor.apply(this, arguments)\n    // This is where all the collection extensions get processed\n    processCollectionExtensions(this, arguments)\n    return ret\n  }\n\n  ns.Collection.prototype = proto\n  ns.Collection.prototype.constructor = ns.Collection\n\n  for (const prop in constructor) {\n    if (Object.prototype.hasOwnProperty.call(constructor, prop)) {\n      ns.Collection[prop] = constructor[prop]\n    }\n  }\n}\n\nfunction processCollectionExtensions (self, args) {\n  // Using old-school operations for better performance\n  // Please don't judge me ;P\n  const applyArgs = args ? [].slice.call(args, 0) : undefined\n  const extensions = CollectionExtensions._extensions\n  for (let i = 0, len = extensions.length; i < len; i++) {\n    extensions[i].apply(self, applyArgs)\n  }\n}\n\nif (typeof Mongo !== 'undefined') {\n  wrapCollection(Meteor, Mongo)\n  wrapCollection(Mongo, Mongo)\n} else {\n  wrapCollection(Meteor, Meteor)\n}\n\nif (typeof Meteor.users !== 'undefined') {\n  // Ensures that Meteor.users instanceof Mongo.Collection\n  reassignCollectionPrototype(Meteor.users)\n}\n"]}