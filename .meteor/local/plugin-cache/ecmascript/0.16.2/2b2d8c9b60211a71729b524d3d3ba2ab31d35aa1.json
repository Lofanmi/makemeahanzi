{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/a37/code/github/makemeahanzi-tool/lib/glyphs.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"lib/glyphs.js","filename":"/Users/a37/code/github/makemeahanzi-tool/lib/glyphs.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/a37/code/github/makemeahanzi-tool","root":"/Users/a37/code/github/makemeahanzi-tool","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/a37/code/github/makemeahanzi-tool/lib/glyphs.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"lib/glyphs.js"}},"code":"module.export({\n  Glyphs: () => Glyphs,\n  Progress: () => Progress\n});\nlet assert;\nmodule.link(\"/lib/base\", {\n  assert(v) {\n    assert = v;\n  }\n\n}, 0);\nlet cjklib;\nmodule.link(\"/lib/cjklib\", {\n  cjklib(v) {\n    cjklib = v;\n  }\n\n}, 1);\n\nconst defaultGlyph = character => {\n  if (!character) return;\n  assert(character.length === 1);\n  const data = cjklib.getCharacterData(character);\n  const result = {\n    character: character,\n    codepoint: character.codePointAt(0),\n    metadata: {\n      frequency: data.frequency,\n      kangxi_index: data.kangxi_index\n    },\n    stages: {},\n    simplified: data.simplified,\n    traditional: data.traditional\n  };\n\n  if (data.simplified) {\n    const glyph = Glyphs.get(data.simplified);\n    const base = cjklib.getCharacterData(data.simplified);\n\n    if (glyph.stages.verified) {\n      const metadata = glyph.metadata;\n      result.metadata.definition = metadata.definition || base.definition;\n      result.metadata.pinyin = metadata.pinyin || base.pinyin;\n    }\n  }\n\n  return result;\n};\n\nconst Glyphs = new Mongo.Collection('glyphs');\nconst Progress = new Mongo.Collection('progress');\n\nGlyphs.clearDependencies = character => {\n  const stack = [character];\n  const visited = {};\n  visited[character] = true;\n\n  while (stack.length > 0) {\n    const current = stack.pop();\n    const dependencies = Glyphs.find({\n      'stages.analysis.decomposition': {\n        $regex: \".*\".concat(current, \".*\")\n      },\n      'stages.order': {\n        $ne: null\n      }\n    }, {\n      character: 1\n    }).fetch();\n    dependencies.map(x => x.character).filter(x => !visited[x]).map(x => {\n      stack.push(x);\n      visited[x] = true;\n    });\n  }\n\n  delete visited[character];\n  Glyphs.update({\n    character: {\n      $in: Object.keys(visited)\n    }\n  }, {\n    $set: {\n      'stages.order': null,\n      'stages.verified': null\n    }\n  }, {\n    multi: true\n  });\n};\n\nGlyphs.get = character => Glyphs.findOne({\n  character: character\n}) || defaultGlyph(character);\n\nGlyphs.getAll = characters => Glyphs.find({\n  character: {\n    $in: characters\n  }\n});\n\nGlyphs.getNext = (glyph, clause) => {\n  clause = clause || {};\n  const codepoint = glyph ? glyph.codepoint : undefined;\n\n  const condition = _.extend({\n    codepoint: {\n      $gt: codepoint\n    }\n  }, clause);\n\n  const next = Glyphs.findOne(condition, {\n    sort: {\n      codepoint: 1\n    }\n  });\n  return next ? next : Glyphs.findOne(clause, {\n    sort: {\n      codepoint: 1\n    }\n  });\n};\n\nGlyphs.getNextUnverified = glyph => {\n  return Glyphs.getNext(glyph, {\n    'stages.verified': null\n  });\n};\n\nGlyphs.getNextVerified = glyph => {\n  return Glyphs.getNext(glyph, {\n    'stages.verified': {\n      $ne: null\n    }\n  });\n};\n\nGlyphs.getPrevious = (glyph, clause) => {\n  clause = clause || {};\n  const codepoint = glyph ? glyph.codepoint : undefined;\n\n  const condition = _.extend({\n    codepoint: {\n      $lt: codepoint\n    }\n  }, clause);\n\n  const previous = Glyphs.findOne(condition, {\n    sort: {\n      codepoint: -1\n    }\n  });\n  return previous ? previous : Glyphs.findOne(clause, {\n    sort: {\n      codepoint: -1\n    }\n  });\n};\n\nGlyphs.getPreviousUnverified = glyph => {\n  return Glyphs.getPrevious(glyph, {\n    'stages.verified': null\n  });\n};\n\nGlyphs.getPreviousVerified = glyph => {\n  return Glyphs.getPrevious(glyph, {\n    'stages.verified': {\n      $ne: null\n    }\n  });\n};\n\nGlyphs.loadAll = characters => {\n  for (let character of characters) {\n    const glyph = Glyphs.get(character);\n\n    if (!glyph.stages.verified) {\n      Glyphs.upsert({\n        character: glyph.character\n      }, glyph);\n    }\n  }\n\n  Progress.refresh();\n};\n\nGlyphs.save = glyph => {\n  check(glyph.character, String);\n  assert(glyph.character.length === 1);\n  const current = Glyphs.get(glyph.character);\n\n  if (current && current.stages.verified && !glyph.stages.verified) {\n    Glyphs.clearDependencies(glyph.character);\n  }\n\n  Glyphs.syncDefinitionAndPinyin(glyph);\n\n  if (glyph.stages.path && !glyph.stages.path.sentinel) {\n    Glyphs.upsert({\n      character: glyph.character\n    }, glyph);\n  } else {\n    Glyphs.remove({\n      character: glyph.character\n    });\n  }\n\n  Progress.refresh();\n};\n\nGlyphs.syncDefinitionAndPinyin = glyph => {\n  const data = cjklib.getCharacterData(glyph.character);\n  const base = cjklib.getCharacterData(data.simplified || glyph.character);\n  const targets = [base.character].concat(base.traditional);\n\n  if (targets.length === 1 || '干么着复'.indexOf(targets[0]) >= 0) {\n    return;\n  }\n\n  const definition = glyph.metadata.definition || data.definition;\n  const pinyin = glyph.metadata.pinyin || data.pinyin;\n  Glyphs.update({\n    character: {\n      $in: targets\n    }\n  }, {\n    $set: {\n      'metadata.definition': definition,\n      'metadata.pinyin': pinyin\n    }\n  }, {\n    multi: true\n  });\n};\n\nProgress.refresh = () => {\n  const total = Glyphs.find().count();\n  const complete = Glyphs.find({\n    'stages.verified': {\n      $ne: null\n    }\n  }).count();\n  Progress.upsert({}, {\n    total: total,\n    complete: complete,\n    backup: false\n  });\n};\n\nif (Meteor.isServer) {\n  // Construct indices on the Glyphs table.\n  Glyphs._ensureIndex({\n    character: 1\n  }, {\n    unique: true\n  });\n\n  Glyphs._ensureIndex({\n    codepoint: 1\n  }, {\n    unique: true\n  });\n\n  Glyphs._ensureIndex({\n    'stages.verified': 1\n  }); // Refresh the Progress counter.\n\n\n  Progress.refresh(); // Register the methods above so they are available to the client.\n\n  const methods = {};\n  const method_names = ['get', 'getNext', 'getNextUnverified', 'getNextVerified', 'getPrevious', 'getPreviousUnverified', 'getPreviousVerified', 'save'];\n  method_names.map(name => methods[\"\".concat(name, \"Glyph\")] = Glyphs[name]);\n  methods.loadAllGlyphs = Glyphs.loadAll;\n\n  methods.saveGlyphs = glyphs => glyphs.map(Glyphs.save);\n\n  Meteor.methods(methods); // Publish accessors that will get all glyphs in a list and get the progress.\n\n  Meteor.publish('getAllGlyphs', Glyphs.getAll);\n  Meteor.publish('getProgress', Progress.find.bind(Progress));\n}","map":{"version":3,"sources":["lib/glyphs.js"],"names":["module","export","Glyphs","Progress","assert","link","v","cjklib","defaultGlyph","character","length","data","getCharacterData","result","codepoint","codePointAt","metadata","frequency","kangxi_index","stages","simplified","traditional","glyph","get","base","verified","definition","pinyin","Mongo","Collection","clearDependencies","stack","visited","current","pop","dependencies","find","$regex","$ne","fetch","map","x","filter","push","update","$in","Object","keys","$set","multi","findOne","getAll","characters","getNext","clause","undefined","condition","_","extend","$gt","next","sort","getNextUnverified","getNextVerified","getPrevious","$lt","previous","getPreviousUnverified","getPreviousVerified","loadAll","upsert","refresh","save","check","String","syncDefinitionAndPinyin","path","sentinel","remove","targets","concat","indexOf","total","count","complete","backup","Meteor","isServer","_ensureIndex","unique","methods","method_names","name","loadAllGlyphs","saveGlyphs","glyphs","publish","bind"],"mappings":"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","sourcesContent":["import {assert} from '/lib/base';\nimport {cjklib} from '/lib/cjklib';\n\nconst defaultGlyph = (character) => {\n  if (!character) return;\n  assert(character.length === 1);\n  const data = cjklib.getCharacterData(character);\n  const result = {\n    character: character,\n    codepoint: character.codePointAt(0),\n    metadata: {\n      frequency: data.frequency,\n      kangxi_index: data.kangxi_index,\n    },\n    stages: {},\n    simplified: data.simplified,\n    traditional: data.traditional,\n  }\n  if (data.simplified) {\n    const glyph = Glyphs.get(data.simplified);\n    const base = cjklib.getCharacterData(data.simplified);\n    if (glyph.stages.verified) {\n      const metadata = glyph.metadata;\n      result.metadata.definition = metadata.definition || base.definition;\n      result.metadata.pinyin = metadata.pinyin || base.pinyin;\n    }\n  }\n  return result;\n}\n\nconst Glyphs = new Mongo.Collection('glyphs');\nconst Progress = new Mongo.Collection('progress');\n\nGlyphs.clearDependencies = (character) => {\n  const stack = [character];\n  const visited = {};\n  visited[character] = true;\n  while (stack.length > 0) {\n    const current = stack.pop();\n    const dependencies = Glyphs.find({\n      'stages.analysis.decomposition': {$regex: `.*${current}.*`},\n      'stages.order': {$ne: null},\n    }, {character: 1}).fetch();\n    dependencies.map((x) => x.character).filter((x) => !visited[x]).map((x) => {\n      stack.push(x);\n      visited[x] = true;\n    });\n  }\n  delete visited[character];\n  Glyphs.update({character: {$in: Object.keys(visited)}},\n                {$set: {'stages.order': null, 'stages.verified': null}},\n                {multi: true});\n}\n\nGlyphs.get = (character) =>\n    Glyphs.findOne({character: character}) || defaultGlyph(character);\n\nGlyphs.getAll = (characters) => Glyphs.find({character: {$in: characters}});\n\nGlyphs.getNext = (glyph, clause) => {\n  clause = clause || {};\n  const codepoint = glyph ? glyph.codepoint : undefined;\n  const condition = _.extend({codepoint: {$gt: codepoint}}, clause);\n  const next = Glyphs.findOne(condition, {sort: {codepoint: 1}});\n  return next ? next : Glyphs.findOne(clause, {sort: {codepoint: 1}});\n}\n\nGlyphs.getNextUnverified = (glyph) => {\n  return Glyphs.getNext(glyph, {'stages.verified': null});\n}\n\nGlyphs.getNextVerified = (glyph) => {\n  return Glyphs.getNext(glyph, {'stages.verified': {$ne: null}});\n}\n\nGlyphs.getPrevious = (glyph, clause) => {\n  clause = clause || {};\n  const codepoint = glyph ? glyph.codepoint : undefined;\n  const condition = _.extend({codepoint: {$lt: codepoint}}, clause);\n  const previous = Glyphs.findOne(condition, {sort: {codepoint: -1}});\n  return previous ? previous : Glyphs.findOne(clause, {sort: {codepoint: -1}});\n}\n\nGlyphs.getPreviousUnverified = (glyph) => {\n  return Glyphs.getPrevious(glyph, {'stages.verified': null});\n}\n\nGlyphs.getPreviousVerified = (glyph) => {\n  return Glyphs.getPrevious(glyph, {'stages.verified': {$ne: null}});\n}\n\nGlyphs.loadAll = (characters) => {\n  for (let character of characters) {\n    const glyph = Glyphs.get(character);\n    if (!glyph.stages.verified) {\n      Glyphs.upsert({character: glyph.character}, glyph);\n    }\n  }\n  Progress.refresh();\n}\n\nGlyphs.save = (glyph) => {\n  check(glyph.character, String);\n  assert(glyph.character.length === 1);\n  const current = Glyphs.get(glyph.character);\n  if (current && current.stages.verified && !glyph.stages.verified) {\n    Glyphs.clearDependencies(glyph.character);\n  }\n  Glyphs.syncDefinitionAndPinyin(glyph);\n  if (glyph.stages.path && !glyph.stages.path.sentinel) {\n    Glyphs.upsert({character: glyph.character}, glyph);\n  } else {\n    Glyphs.remove({character: glyph.character});\n  }\n  Progress.refresh();\n}\n\nGlyphs.syncDefinitionAndPinyin = (glyph) => {\n  const data = cjklib.getCharacterData(glyph.character);\n  const base = cjklib.getCharacterData(data.simplified || glyph.character);\n  const targets = [base.character].concat(base.traditional);\n  if (targets.length === 1 || '干么着复'.indexOf(targets[0]) >= 0) {\n    return;\n  }\n  const definition = glyph.metadata.definition || data.definition;\n  const pinyin = glyph.metadata.pinyin || data.pinyin;\n  Glyphs.update({character: {$in: targets}}, {$set: {\n    'metadata.definition': definition,\n    'metadata.pinyin': pinyin,\n  }}, {multi: true});\n}\n\nProgress.refresh = () => {\n  const total = Glyphs.find().count();\n  const complete = Glyphs.find({'stages.verified': {$ne: null}}).count();\n  Progress.upsert({}, {total: total, complete: complete, backup: false});\n}\n\nif (Meteor.isServer) {\n  // Construct indices on the Glyphs table.\n  Glyphs._ensureIndex({character: 1}, {unique: true});\n  Glyphs._ensureIndex({codepoint: 1}, {unique: true});\n  Glyphs._ensureIndex({'stages.verified': 1});\n\n  // Refresh the Progress counter.\n  Progress.refresh();\n\n  // Register the methods above so they are available to the client.\n  const methods = {};\n  const method_names = [\n      'get', 'getNext', 'getNextUnverified', 'getNextVerified',\n      'getPrevious', 'getPreviousUnverified', 'getPreviousVerified', 'save'];\n  method_names.map((name) => methods[`${name}Glyph`] = Glyphs[name]);\n  methods.loadAllGlyphs = Glyphs.loadAll;\n  methods.saveGlyphs = (glyphs) => glyphs.map(Glyphs.save);\n  Meteor.methods(methods);\n\n  // Publish accessors that will get all glyphs in a list and get the progress.\n  Meteor.publish('getAllGlyphs', Glyphs.getAll);\n  Meteor.publish('getProgress', Progress.find.bind(Progress));\n}\n\nexport {Glyphs, Progress};\n"]},"sourceType":"module","externalDependencies":{},"hash":"2b2d8c9b60211a71729b524d3d3ba2ab31d35aa1"}
